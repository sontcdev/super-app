name: Deploy to Alibaba Cloud OSS

on:
  push:
    branches: [ "main" ]
    paths:
      - 'mini-apps/**'
      - 'shell/**'
  workflow_dispatch:

env:
  OSS_BUCKET: superapp-miniapps
  OSS_ENDPOINT: oss-ap-southeast-1.aliyuncs.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Build buy-sim mini app
        working-directory: mini-apps/buy-sim
        run: |
          flutter pub get
          flutter build web --release --base-href /buy-sim/

      - name: Build payment mini app
        working-directory: mini-apps/payment
        run: |
          flutter pub get
          flutter build web --release --base-href /payment/

      - name: Copy build outputs to shell folder
        run: |
          cp -r mini-apps/buy-sim/build/web shell/buy-sim
          cp -r mini-apps/payment/build/web shell/payment

      - name: Setup ossutil
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: ${{ env.OSS_ENDPOINT }}
          access-key-id: ${{ secrets.ALI_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ALI_ACCESS_KEY_SECRET }}

      - name: Deploy shell folder to OSS
        run: |
          ossutil cp -r shell/ oss://${{ env.OSS_BUCKET }}/ -f --acl public-read
