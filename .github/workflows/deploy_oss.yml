name: Deploy to Alibaba Cloud OSS

on:
  push:
    branches: [ "main" ]
    paths:
      - 'mini-apps/**'
      - 'shell/**'
  workflow_dispatch:

env:
  OSS_BUCKET: superapp-miniapps
  OSS_ENDPOINT: oss-ap-southeast-1.aliyuncs.com

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Build all mini apps automatically
        run: |
          echo "üîç Detecting mini-apps..."
          for app_dir in mini-apps/*/; do
            if [ -f "$app_dir/pubspec.yaml" ]; then
              app_name=$(basename "$app_dir")
              echo "üì± Building $app_name..."
              
              cd "$app_dir"
              flutter pub get
              flutter build web --release --base-href "/$app_name/"
              cd ../..
              
              echo "üì¶ Copying $app_name to shell/$app_name..."
              rm -rf "shell/$app_name"
              mkdir -p "shell/$app_name"
              cp -r "$app_dir/build/web/"* "shell/$app_name/"
              
              echo "‚úÖ $app_name built successfully!"
            fi
          done
          echo "üéâ All mini-apps built!"

      - name: Setup ossutil
        uses: manyuanrong/setup-ossutil@v2.0
        with:
          endpoint: ${{ env.OSS_ENDPOINT }}
          access-key-id: ${{ secrets.ALI_ACCESS_KEY_ID }}
          access-key-secret: ${{ secrets.ALI_ACCESS_KEY_SECRET }}

      - name: Deploy shell folder to OSS
        run: |
          ossutil cp -r shell/ oss://${{ env.OSS_BUCKET }}/ -f --acl public-read
